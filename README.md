# Bungo

> 技ったぜ。　投稿者:忍耐ガチデスマ (10月12日（祝）09時46分19秒)
> 昨日の10月12日にいつもの専攻科生(2年生)と先日メールくれた本科生(4年生)とパンフレットに1年生と書かれてしまった専攻科生のわし(2年生)の3人で県北にあるホクト文化ホールで技術あったぜ。
> 今日は明日が敗者復活戦なんでコンビニでしこたまカップラーメンと栄養剤を買ってから滅多に釧路高専チームが進めない決勝なんで、ホテルでしこたま栄養剤を飲んでから技術はじめたんや。
> 3台でスイッチを設置しながら靴下だけになり持って来たLANケーブルを3本ずつ入れあった。
> しばらくしたら、NICがアドレスを取得して来るし、パケットが出口を求めてカーネルの中でぐるぐるしている。
> サーバプログラムにリストをけつからなめさせていたら、先にNICがパケットをドバーっと出して来た。
> それと同時にクライアントプログラムも回答を出したんや。もうマップ中、石まみれや、3台で出した回答を検証し色をぬりあったり、石まみれのマップを眺めあって評価関数を改善したりした。ああ〜たまらねえぜ。
> しばらく技術まくってから又評価関数を改善しあうともう気が狂う程眠たくなるんじゃ。
> リストに石情報を突うずるっ込んでやるとメモリが0と1だけじゃ何も伝えらんないよね…して気持ちが良い。
> サーバプログラムも運営サーバに回答を突っ込んでコネクションをつかって居る。
> 石まみれのマップを眺めながら、思い切り送信したんや。
> それからは、もうめちゃくちゃにマップと石情報を舐めあい、石を置きあい、二回も最適解を出した。もう一度技術たいぜ。
> やはり大勢で石まみれになると最高やで。こんな、ガチデスマと石あそびしないか。ああ〜早く石まみれになろうぜ。
> 北海の道東であえる奴なら最高や。石まみれになりたいやつ、至急、メールくれや。
> チェックシャツ姿のまま回答して、石だらけでやろうや。

絶望的に汚い。


## システム概要

* 3台のPCを使うことを前提
* 1台のPCを「サーバ」とする
  * Hikariと名付けた
  * これが運営サーバと通信
  * なお、模擬運営サーバも「Akane」として作っていた
  * はにかむ～
* 3台のうち、1台以上に「クライアント」を設置
  * ソルバ
  * 「クライアント」は、「サーバ(Hikari)」と通信
  * PCの状況(CPU使用率など)に応じて、1台に複数のクライアントを設置
* クライアント・サーバ間の、問題・回答送受信は、独自フォーマットにて行う
  * 余計な改行を省く
  * (C/C++を用いる)クライアントでパースがしやすいように
  * 通信量削減
    * マップ情報と石情報は、改行以外は公式フォーマットのまま、ASCII文字で'0'と'1'を送信するだけなので無駄も多かった
	* その中でも、石情報は、最大16文字でいけるのに、きっちり64文字分送ってしまい、無駄が多かった
	* ほとんどのクライアントで、「石を、石に含まれているあるブロックを基準として、そこからの相対座標で表現」という処理を行っていた。
	  * このぐらいの処理は、Hikari側でやってしまえばよかったかも知れない
* クライアント・サーバ間は、競技開始前に接続しておく
  * 3-Way Handshakeの確立をうんぬん
  * 競技開始と同時に人間が繋ぐと遅い
  * クライアントは、サーバから応答があるまでブロック
  * サーバは、競技開始と同時にクライアントに問題を送信
  * 回答が来て、それがベストだったら運営サーバに報告


## 試合の流れ

1. Hikariを立ち上げる
  * 試合に関する情報(運営サーバのアドレス、トークン、問題番号など)を設定
  * Hikariが動作しているPCのIPアドレスを確認
  * 運営サーバと接続確認
  * 運営サーバと「コネ作り(`Connection: Keep-Alive`)」を行う
  * Wireshark、NetworkMinerを起動しておく
2. クライアントをHikariに接続する
3. 試合開始まで待つ
4. 試合が開始されたら、Hikariの「試合開始」ボタンを押す
5. Hikariからクライアントに向けて、問題が一斉送信(ユニキャストだけど)される
  * マルチキャストを使えば良かったかな
  * 時間のNASAから本来ルータを使うところをスイッチで代用したから、無理だったけど
6. クライアントからHikariに、回答がやってくる
  * Hikariが認識している中で、最良解であれば、運営サーバに報告
    * ただし、「運営サーバに対し、短時間に解を送信してしまった」のは避ける
	* 2000ms待機して、その間に解が送られてこなかったら…とする
	* 回答、ためて待つぜ。
  * 最良解ではない場合や、(Hikariによる)有効回答でないと判断された場合は、放置する
7. 試合終了まで継続
8. 試合が終わったら、クライアントとHikariを終了
  * 繋ぎっぱなしを想定していたが、不安なのでこうした
9. 次の試合に備えるため、最初から繰り返す


## ディレクトリ構成
このリポジトリのディレクトリ構成について示す。
~~~~
.
├── OfficialServer/
│   ├── Akane/
│   │   └── (模擬公式サーバ)
│   ├── Board/
│   │   └── (敷地情報を扱うユーザコントロール AkaneとHikariで利用)
│   └── Problem/
│        └── (問題情報を扱うクラス Akaneで利用)
├── KpcServer/
│   ├── Hikari/
│   │   └── (3台のPCを束ねるアレ)
│   └── NewProblem/
│        └── (OfficialServer/Problemの亜種 Hikariで利用)
├── Client/
│   ├── DAMEDESU/
│   │   └── (動かないソルバたち)
│   ├── KusoZako/
│   │   └── (動くけどクソザコなソルバたち。zkならぬkz(屑))
│   ├── God/
│   │   └── (神、いわゆるゴッド)
│   ├── TUYOI\_Solver/
│   │   └── (本戦で活躍した強いソルバたち)
│   └── Sample/
│        └── (ソルバのサンプル)
└── Problem/
    └── (擬似問題)
~~~~


## ビルドについて

* 頑張ってください
* Hikariと適当なクライアントさえビルドすれば大丈夫です
* Hikariの`-> http://172.16....`というところに問題ファイルをドラッグ&ドロップすれば、Hikariの実行ファイルと同じディレクトリに回答が出てきます

## 質問など

### 強いソルバについて
* [@cafeunder](https://twitter.com/cafeunder)

### クソザコソルバとシステムについて
* [@\_\_lrks\_\_](https://twitter.com/__lrks__)
